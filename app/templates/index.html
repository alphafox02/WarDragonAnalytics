<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WarDragon Analytics - Tactical Operations</title>

    <!-- Leaflet CSS (local for offline operation) -->
    <link rel="stylesheet" href="/static/vendor/leaflet.css" />
    <!-- Leaflet Draw CSS (local for offline operation) -->
    <link rel="stylesheet" href="/static/vendor/leaflet.draw.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>WarDragon Analytics</h1>
        <div class="header-controls">
            <button class="btn-icon btn-ai" onclick="toggleAIChat()" title="AI Assistant" id="ai-chat-btn">
                <span class="ai-icon">AI</span> Ask
            </button>
            <button class="btn-icon" onclick="openKitManager()" title="Manage Kits">Kits</button>
            <button class="theme-toggle" onclick="toggleTheme()">Theme</button>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span id="refresh-status">Auto-refresh: 5s</span>
            </div>
            <div class="status-indicator">
                <span id="last-update">Last update: --</span>
            </div>
        </div>
    </div>

    <!-- AI Chat Panel -->
    <div id="ai-chat-panel" class="ai-chat-panel">
        <div class="ai-chat-header">
            <h3>AI Assistant</h3>
            <div class="ai-chat-status" id="ai-status">
                <span class="ai-status-dot"></span>
                <span id="ai-status-text">Checking...</span>
            </div>
            <button class="ai-chat-close" onclick="toggleAIChat()">&times;</button>
        </div>

        <div class="ai-chat-messages" id="ai-messages">
            <!-- Welcome message -->
            <div class="ai-message ai-message-assistant">
                <div class="ai-message-content">
                    <p><strong>Welcome!</strong> I can help you explore your drone detection data.</p>
                    <p>Try asking questions like:</p>
                    <ul>
                        <li>"What drones were seen in the last hour?"</li>
                        <li>"Show me DJI drones above 100 meters"</li>
                        <li>"How many unique drones today?"</li>
                        <li>"Any FPV signals detected?"</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="ai-quick-queries" id="ai-quick-queries">
            <div class="ai-quick-label">Quick queries:</div>
            <div class="ai-quick-buttons">
                <button onclick="sendAIQuery('What drones were seen in the last hour?')">Recent drones</button>
                <button onclick="sendAIQuery('How many unique drones today?')">Today's count</button>
                <button onclick="sendAIQuery('Any FPV signals detected?')">FPV signals</button>
                <button onclick="sendAIQuery('Which kit detected the most?')">Kit stats</button>
            </div>
        </div>

        <div class="ai-chat-input-container">
            <textarea
                id="ai-input"
                class="ai-chat-input"
                placeholder="Ask about your drone data..."
                rows="2"
                onkeydown="handleAIInputKeydown(event)"
            ></textarea>
            <button class="ai-chat-send" onclick="sendAIQueryFromInput()" id="ai-send-btn">
                Send
            </button>
        </div>

        <div class="ai-chat-footer">
            <span id="ai-model-info">Model: --</span>
            <button class="ai-clear-btn" onclick="clearAIChat()">Clear Chat</button>
        </div>
    </div>

    <!-- Kit Manager Modal -->
    <div id="kit-manager-modal" class="modal">
        <div class="modal-content kit-manager-content">
            <div class="modal-header">
                <h2>Kit Management</h2>
                <button class="modal-close" onclick="closeKitManager()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Add New Kit Section -->
                <div class="kit-add-section">
                    <h3>Add New Kit</h3>
                    <div class="kit-form">
                        <div class="form-row">
                            <label for="new-kit-url">API URL *</label>
                            <input type="text" id="new-kit-url" placeholder="http://192.168.1.100:8088" />
                        </div>
                        <div class="form-row">
                            <label for="new-kit-name">Name (optional)</label>
                            <input type="text" id="new-kit-name" placeholder="Mobile Unit Alpha" />
                        </div>
                        <div class="form-row">
                            <label for="new-kit-location">Location (optional)</label>
                            <input type="text" id="new-kit-location" placeholder="Field Operations HQ" />
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary" onclick="testNewKit()">Test Connection</button>
                            <button class="btn" onclick="addNewKit()">Add Kit</button>
                        </div>
                        <div id="kit-test-result" class="kit-test-result"></div>
                    </div>
                </div>

                <!-- Existing Kits Section -->
                <div class="kit-list-section">
                    <h3>Configured Kits</h3>
                    <div id="kit-list" class="kit-list">
                        <div class="loading">Loading kits...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Banner (compact ticker style) -->
    <div id="alert-banner" class="alert-banner">
        <div class="alert-banner-content">
            <span id="alert-badge" class="alert-badge" onclick="toggleAlertDropdown()">
                <span class="alert-icon">‚ö†</span>
                <span id="alert-count">0</span> alerts
            </span>
            <div id="alert-ticker" class="alert-ticker">
                <span id="alert-current" class="alert-current"></span>
            </div>
            <div class="alert-controls">
                <button class="alert-nav-btn" onclick="prevAlert()" title="Previous">‚Äπ</button>
                <button class="alert-nav-btn" onclick="nextAlert()" title="Next">‚Ä∫</button>
                <button class="alert-clear-btn" onclick="clearAllAlerts()" title="Clear All">‚úï</button>
            </div>
        </div>
        <!-- Expandable dropdown for full list -->
        <div id="alert-dropdown" class="alert-dropdown">
            <div class="alert-dropdown-header">
                <span>All Alerts</span>
                <button onclick="toggleAlertDropdown()">Close</button>
            </div>
            <div id="alerts-list" class="alerts-list"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>Quick Filters</h2>

            <!-- Quick Filter Buttons -->
            <div class="quick-filters">
                <button id="filter-showUnusual" class="quick-filter-btn" onclick="toggleQuickFilter('showUnusual')">
                    <span>Show Unusual</span>
                    <span id="unusual-count" class="count">0</span>
                </button>
                <button id="filter-showRepeated" class="quick-filter-btn" onclick="toggleQuickFilter('showRepeated')">
                    <span>Show Repeated</span>
                    <span id="repeated-count" class="count">0</span>
                </button>
                <button id="filter-showMultikit" class="quick-filter-btn" onclick="toggleQuickFilter('showMultikit')">
                    <span>Show Multi-Kit</span>
                    <span id="multikit-count" class="count">0</span>
                </button>
                <button id="filter-showCoordinated" class="quick-filter-btn" onclick="toggleQuickFilter('showCoordinated')" title="Drones flying in coordinated patterns">
                    <span>Show Coordinated</span>
                    <span id="coordinated-count" class="count">0</span>
                </button>
                <button class="quick-filter-btn" onclick="fitToAllDrones()" title="Zoom map to show all drones">
                    <span>Fit to All Drones</span>
                </button>
            </div>

            <h2>RID Watchlist</h2>

            <!-- Watchlist Input -->
            <div class="filter-section">
                <label>Add Drone ID to Watch</label>
                <div class="watchlist-input-group">
                    <input type="text" id="watchlist-input" placeholder="Enter drone ID..." onkeypress="if(event.key==='Enter') { addToWatchlist(document.getElementById('watchlist-input').value); document.getElementById('watchlist-input').value = ''; }">
                    <button class="watchlist-add-btn" onclick="addToWatchlist(document.getElementById('watchlist-input').value); document.getElementById('watchlist-input').value = '';">Add</button>
                </div>
                <div id="watchlist-items" class="watchlist-items"></div>
            </div>

            <h2>Filters</h2>

            <!-- Time Range -->
            <div class="filter-section">
                <label>Time Range</label>
                <select id="time-range">
                    <option value="1h" selected>Last 1 hour</option>
                    <option value="24h">Last 24 hours</option>
                    <option value="7d">Last 7 days</option>
                </select>
            </div>

            <!-- Kit Selection -->
            <div class="filter-section">
                <label>Kit Source</label>
                <div id="kit-checkboxes" class="checkbox-group">
                    <label>
                        <input type="checkbox" value="all" checked> All Kits
                    </label>
                </div>
            </div>

            <!-- Track Type -->
            <div class="filter-section">
                <label>Track Type</label>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="show-drones" checked> Drones
                    </label>
                    <label>
                        <input type="checkbox" id="show-aircraft" checked> Aircraft
                    </label>
                    <label>
                        <input type="checkbox" id="show-signals" checked onchange="toggleSignals(this.checked)"> Signals (S)
                    </label>
                </div>
            </div>

            <!-- Pilot/Home Locations -->
            <div class="filter-section">
                <label>Show Locations</label>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="show-pilot" checked onchange="togglePilotLocations(this.checked)"> Pilot (P)
                    </label>
                    <label>
                        <input type="checkbox" id="show-home" checked onchange="toggleHomeLocations(this.checked)"> Home (H)
                    </label>
                </div>
            </div>

            <!-- RID Make -->
            <div class="filter-section">
                <label>RID Make</label>
                <select id="rid-make">
                    <option value="">All Makes</option>
                    <option value="DJI">DJI</option>
                    <option value="Autel">Autel</option>
                    <option value="Parrot">Parrot</option>
                    <option value="Skydio">Skydio</option>
                </select>
            </div>

            <!-- Geographic Filter -->
            <div class="filter-section">
                <label>Geographic Filter</label>
                <div class="geo-filter-controls">
                    <div style="font-size: 11px; color: #aaa; margin-bottom: 8px;">
                        Use the polygon/rectangle tools on the map to draw a filter area
                    </div>
                </div>
            </div>

            <!-- Auto-refresh -->
            <div class="filter-section">
                <label>Auto-Refresh</label>
                <select id="refresh-interval">
                    <option value="5">Every 5 seconds</option>
                    <option value="10">Every 10 seconds</option>
                    <option value="30">Every 30 seconds</option>
                    <option value="0">Disabled</option>
                </select>
            </div>

            <!-- Actions -->
            <button class="btn" onclick="applyFilters()">Apply Filters</button>
            <button class="btn btn-secondary" onclick="exportCSV()">Export CSV</button>
            <button class="btn btn-secondary" onclick="window.open('http://localhost:3000', '_blank')">View Grafana</button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Threat Summary Cards -->
            <div class="threat-summary">
                <div class="threat-card critical" onclick="filterByThreatCard('unusual')">
                    <div class="threat-card-label">Active Threats</div>
                    <div id="active-threats" class="threat-card-value">0</div>
                    <div class="threat-card-detail">Anomalies detected in last hour</div>
                </div>
                <div class="threat-card warning" onclick="filterByThreatCard('repeated')">
                    <div class="threat-card-label">Repeated Contacts</div>
                    <div id="repeated-contacts" class="threat-card-value">0</div>
                    <div class="threat-card-detail">Drones seen 2+ times</div>
                </div>
                <div class="threat-card" onclick="filterByThreatCard('multikit')">
                    <div class="threat-card-label">Multi-Kit Detections</div>
                    <div id="multi-kit-detections" class="threat-card-value">0</div>
                    <div class="threat-card-detail">Drones seen by 2+ kits</div>
                </div>
                <div class="threat-card warning" onclick="filterByThreatCard('unusual')">
                    <div class="threat-card-label">Anomalies Detected</div>
                    <div id="anomalies-count" class="threat-card-value">0</div>
                    <div class="threat-card-detail">Click to filter anomalous drones</div>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-container">
                <div class="stat-badge">
                    <div class="stat-label">Total Tracks</div>
                    <div class="stat-value" id="total-tracks">0</div>
                </div>
                <div class="stat-badge">
                    <div class="stat-label">Drones</div>
                    <div class="stat-value" id="total-drones">0</div>
                </div>
                <div class="stat-badge">
                    <div class="stat-label">Aircraft</div>
                    <div class="stat-value" id="total-aircraft">0</div>
                </div>
                <div class="stat-badge signal-badge">
                    <div class="stat-label">Signals</div>
                    <div class="stat-value" id="total-signals">0</div>
                </div>
                <div class="stat-badge">
                    <div class="stat-label">Active Kits</div>
                    <div class="stat-value" id="active-kits">0</div>
                </div>
            </div>

            <!-- Map -->
            <div class="map-container">
                <div id="map"></div>
                <!-- Empty state overlay when filters match nothing -->
                <div id="filter-empty-state" class="filter-empty-state" style="display: none;">
                    <div class="empty-state-content">
                        <div class="empty-state-icon">üîç</div>
                        <div class="empty-state-title">No matches found</div>
                        <div id="empty-state-filters" class="empty-state-filters"></div>
                        <button onclick="clearAllPatternFilters()" class="empty-state-btn">Clear Filters</button>
                    </div>
                </div>
            </div>

            <!-- Tabbed Data Table -->
            <div class="data-table-section">
                <!-- Tab Navigation -->
                <div class="data-tabs">
                    <button class="data-tab active" data-tab="drones" onclick="switchDataTab('drones')">
                        <span class="tab-icon">üõ∏</span>
                        <span class="tab-label">Drones</span>
                        <span class="tab-count" id="tab-drone-count">0</span>
                    </button>
                    <button class="data-tab" data-tab="aircraft" onclick="switchDataTab('aircraft')">
                        <span class="tab-icon">‚úàÔ∏è</span>
                        <span class="tab-label">Aircraft</span>
                        <span class="tab-count" id="tab-aircraft-count">0</span>
                    </button>
                    <button class="data-tab" data-tab="signals" onclick="switchDataTab('signals')">
                        <span class="tab-icon">üì°</span>
                        <span class="tab-label">Signals</span>
                        <span class="tab-count" id="tab-signal-count">0</span>
                    </button>
                </div>

                <!-- Drones Table -->
                <div class="data-table-panel active" id="drones-panel">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="sortable active" data-sort="time" data-table="drones" onclick="sortTable('time', 'drones')">Time <span class="sort-arrow">‚ñº</span></th>
                                    <th class="sortable" data-sort="kit_id" data-table="drones" onclick="sortTable('kit_id', 'drones')">Kit <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="drone_id" data-table="drones" onclick="sortTable('drone_id', 'drones')">Drone ID <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="rid_make" data-table="drones" onclick="sortTable('rid_make', 'drones')">Make <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="rid_model" data-table="drones" onclick="sortTable('rid_model', 'drones')">Model <span class="sort-arrow"></span></th>
                                    <th>Lat</th>
                                    <th>Lon</th>
                                    <th class="sortable" data-sort="alt" data-table="drones" onclick="sortTable('alt', 'drones')">Alt (m) <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="speed" data-table="drones" onclick="sortTable('speed', 'drones')">Speed (m/s) <span class="sort-arrow"></span></th>
                                </tr>
                            </thead>
                            <tbody id="drones-table">
                                <tr><td colspan="9" style="text-align: center; color: #aaa;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="table-pagination" id="drones-pagination">
                        <div class="pagination-info">
                            <span id="drones-page-info">Showing 0 of 0</span>
                            <select class="page-size-select" id="drones-page-size" onchange="changePageSize('drones', this.value)">
                                <option value="25">25 per page</option>
                                <option value="50" selected>50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                        <div class="pagination-controls" id="drones-page-controls"></div>
                    </div>
                </div>

                <!-- Aircraft Table -->
                <div class="data-table-panel" id="aircraft-panel">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="sortable active" data-sort="time" data-table="aircraft" onclick="sortTable('time', 'aircraft')">Time <span class="sort-arrow">‚ñº</span></th>
                                    <th class="sortable" data-sort="kit_id" data-table="aircraft" onclick="sortTable('kit_id', 'aircraft')">Kit <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="drone_id" data-table="aircraft" onclick="sortTable('drone_id', 'aircraft')">ICAO/ID <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="callsign" data-table="aircraft" onclick="sortTable('callsign', 'aircraft')">Callsign <span class="sort-arrow"></span></th>
                                    <th>Lat</th>
                                    <th>Lon</th>
                                    <th class="sortable" data-sort="alt" data-table="aircraft" onclick="sortTable('alt', 'aircraft')">Alt (m) <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="speed" data-table="aircraft" onclick="sortTable('speed', 'aircraft')">Speed (m/s) <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="heading" data-table="aircraft" onclick="sortTable('heading', 'aircraft')">Heading <span class="sort-arrow"></span></th>
                                </tr>
                            </thead>
                            <tbody id="aircraft-table">
                                <tr><td colspan="9" style="text-align: center; color: #aaa;">No aircraft data</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="table-pagination" id="aircraft-pagination">
                        <div class="pagination-info">
                            <span id="aircraft-page-info">Showing 0 of 0</span>
                            <select class="page-size-select" id="aircraft-page-size" onchange="changePageSize('aircraft', this.value)">
                                <option value="25">25 per page</option>
                                <option value="50" selected>50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                        <div class="pagination-controls" id="aircraft-page-controls"></div>
                    </div>
                </div>

                <!-- Signals Table -->
                <div class="data-table-panel" id="signals-panel">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="sortable active" data-sort="time" data-table="signals" onclick="sortTable('time', 'signals')">Time <span class="sort-arrow">‚ñº</span></th>
                                    <th class="sortable" data-sort="kit_id" data-table="signals" onclick="sortTable('kit_id', 'signals')">Kit <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="freq_mhz" data-table="signals" onclick="sortTable('freq_mhz', 'signals')">Freq (MHz) <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="power_dbm" data-table="signals" onclick="sortTable('power_dbm', 'signals')">Signal <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="pal_conf" data-table="signals" onclick="sortTable('pal_conf', 'signals')">PAL % <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="ntsc_conf" data-table="signals" onclick="sortTable('ntsc_conf', 'signals')">NTSC % <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="detection_type" data-table="signals" onclick="sortTable('detection_type', 'signals')">Type <span class="sort-arrow"></span></th>
                                    <th>Lat</th>
                                    <th>Lon</th>
                                </tr>
                            </thead>
                            <tbody id="signals-table">
                                <tr><td colspan="9" style="text-align: center; color: #aaa;">No signal data</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="table-pagination" id="signals-pagination">
                        <div class="pagination-info">
                            <span id="signals-page-info">Showing 0 of 0</span>
                            <select class="page-size-select" id="signals-page-size" onchange="changePageSize('signals', this.value)">
                                <option value="25">25 per page</option>
                                <option value="50" selected>50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                        <div class="pagination-controls" id="signals-page-controls"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS (local for offline operation) -->
    <script src="/static/vendor/leaflet.js"></script>
    <!-- Leaflet Draw JS (local for offline operation) -->
    <script src="/static/vendor/leaflet.draw.js"></script>

    <!-- Custom JS -->
    <script src="/static/map.js"></script>
</body>
</html>
